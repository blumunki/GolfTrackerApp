@page "/rounds"
@layout MobileLayout
@using GolfTrackerApp.Mobile.Models
@using GolfTrackerApp.Mobile.Services.Api
@using System.Text.Json
@inject HttpClient Http
@inject IRoundApiService RoundApiService
@inject IJSRuntime JSRuntime

@* Use aliases to resolve namespace conflicts *@
@using ApiRound = GolfTrackerApp.Mobile.Services.Api.Round
@using LocalRound = GolfTrackerApp.Mobile.Models.Round

<MudContainer Class="pa-2" Style="height: calc(100vh - 144px); overflow-y: auto;">
    <!-- Search and Add Actions -->
    <div class="d-flex align-center justify-space-between mb-3">
        <MudText Typo="Typo.h4" Color="Color.Primary">üèåÔ∏è Rounds</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                      Color="Color.Primary" 
                      Size="Size.Large"
                      OnClick="@(() => JSRuntime.InvokeVoidAsync("alert", "Record new round coming soon!"))" />
    </div>
    
    <!-- Search Bar -->
    <MudPaper Class="pa-3 mb-4" Elevation="2" Style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
        <MudTextField @bind-Value="searchString" 
                      Label="Search by course or club..." 
                      Variant="Variant.Outlined" 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" 
                      DebounceInterval="300" 
                      OnDebounceIntervalElapsed="OnSearchTextChanged"
                      Margin="Margin.Dense"
                      FullWidth="true" />
    </MudPaper>
    
    @if (loading)
    {
        <div class="text-center pa-4">
            <MudProgressCircular Size="Size.Large" Indeterminate="true" Color="Color.Primary" />
            <MudText Typo="Typo.body1" Class="mt-3" Color="Color.Secondary">Loading your rounds...</MudText>
        </div>
    }
    else if (filteredRounds?.Any() == true)
    {
        <MudList T="object" Class="rounds-list">
            @foreach (var round in filteredRounds)
            {
                <MudListItem T="object" Class="round-list-item">
                    <MudCard Elevation="2" 
                             Class="mb-3 round-card" 
                             Style="border-left: 4px solid #667eea; cursor: pointer; transition: all 0.2s ease;"
                             @onclick="@(() => ShowRoundDetails(round))">
                        <MudCardContent Class="pa-3">
                            <div class="d-flex justify-space-between align-start">
                                <!-- Main Round Info -->
                                <div class="flex-grow-1">
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" 
                                                Size="Size.Small" 
                                                Class="mr-2" 
                                                Color="Color.Primary" />
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            @round.DatePlayed.ToString("MMM dd, yyyy")
                                        </MudText>
                                    </div>
                                    
                                    <div class="d-flex align-center mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.GolfCourse" 
                                                Size="Size.Small" 
                                                Class="mr-2" 
                                                Color="Color.Success" />
                                        <div class="flex-grow-1">
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                @round.ClubName
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @round.CourseName
                                            </MudText>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex align-center gap-4">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Flag" 
                                                    Size="Size.Small" 
                                                    Class="mr-1" 
                                                    Color="Color.Info" />
                                            <MudText Typo="Typo.caption">
                                                @GetRoundTypeDisplay(round)
                                            </MudText>
                                        </div>
                                        
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.People" 
                                                    Size="Size.Small" 
                                                    Class="mr-1" 
                                                    Color="Color.Warning" />
                                            <MudText Typo="Typo.caption">
                                                @GetPlayerCountDisplay(round) players
                                            </MudText>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="d-flex flex-column align-center ml-2">
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                  Color="Color.Primary" 
                                                  Size="Size.Small"
                                                  OnClick="@(() => ShowRoundDetails(round))" />
                                    <MudMenu>
                                        <ActivatorContent>
                                            <MudIconButton Icon="@Icons.Material.Filled.MoreVert" 
                                                          Color="Color.Secondary" 
                                                          Size="Size.Small" />
                                        </ActivatorContent>
                                        <ChildContent>
                                            <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                                         OnClick="@(() => ShowRoundDetails(round))">
                                                View Details
                                            </MudMenuItem>
                                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                                         OnClick="@(() => EditRoundFromMenu(round))">
                                                Edit Round
                                            </MudMenuItem>
                                            <MudDivider />
                                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" 
                                                         OnClick="@(() => DeleteRoundFromMenu(round))"
                                                         Style="color: var(--mud-palette-error);">
                                                Delete Round
                                            </MudMenuItem>
                                        </ChildContent>
                                    </MudMenu>
                                </div>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudListItem>
            }
        </MudList>
        
        @if (totalRounds > filteredRounds.Count)
        {
            <div class="text-center mt-4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Showing @filteredRounds.Count of @totalRounds rounds
                </MudText>
            </div>
        }
    }
    else if (!loading && rounds?.Any() == true)
    {
        <!-- No search results -->
        <div class="text-center pa-4">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">No rounds found</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Try adjusting your search terms</MudText>
        </div>
    }
    else
    {
        <!-- No rounds at all -->
        <div class="text-center pa-4">
            <MudIcon Icon="@Icons.Material.Filled.GolfCourse" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-2">No rounds recorded yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                Get out there and play some golf!
            </MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@(() => JSRuntime.InvokeVoidAsync("alert", "Record new round coming soon!"))">
                Record Your First Round
            </MudButton>
        </div>
    }
</MudContainer>

<!-- Round Details Dialog -->
<MudDialog @bind-Visible="showDetailsDialog" Options="detailsDialogOptions">
    <DialogContent>
        @if (selectedRound != null)
        {
            <!-- Round Header -->
            <div class="mb-4">
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="mb-1">
                    üìç @selectedRound.CourseName
                </MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                    @selectedRound.ClubName
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Tertiary">
                    @selectedRound.DatePlayed.ToString("dddd, MMMM dd, yyyy")
                </MudText>
            </div>
            
            <!-- Round Summary Cards -->
                        <!-- Round Details -->
            
            <!-- Round Details -->
            <MudCard Elevation="1" Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">üìã Round Details</MudText>
                    
                    <div class="d-flex justify-space-between mb-3">
                        <MudText Typo="Typo.body2">Round Type:</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@GetRoundTypeDisplay(selectedRound)</MudText>
                    </div>
                    
                    @if (selectedRound.PlayingPartners?.Any() == true)
                    {
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-2">Players:</MudText>
                            <div class="d-flex flex-column gap-1">
                                @foreach (var (partner, index) in selectedRound.PlayingPartners.Select((p, i) => (p, i)))
                                {
                                    <MudText Typo="Typo.body2" Style="font-weight: 500; margin-left: 16px;">
                                        @(index + 1). @partner
                                    </MudText>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(selectedRound.Notes))
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.body2" Class="mb-2">Notes:</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-style: italic;">
                            @selectedRound.Notes
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
            
            <!-- Player Scorecards -->
            @if (apiScores?.Any() == true)
            {
                <MudCard Elevation="1">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-3">üèåÔ∏è Scorecards</MudText>
                        
                        @foreach (var playerGroup in apiScores.GroupBy(s => s.PlayerId))
                        {
                            var playerId = playerGroup.Key;
                            var player = playerGroup.First().Player;
                            var playerScores = playerGroup.OrderBy(s => s.Hole?.HoleNumber).ToList();
                            var totalStrokes = playerScores.Sum(s => s.Strokes);
                            var totalPar = playerScores.Sum(s => s.Hole?.Par ?? 4);
                            var scoreToPar = totalStrokes - totalPar;
                            var isExpanded = expandedPlayers.GetValueOrDefault(playerId, false);
                            
                            <MudCard Elevation="2" Class="mb-3">
                                <MudCardContent Class="pa-3">
                                    <!-- Player Summary (always visible) -->
                                    <div class="d-flex justify-space-between align-center" 
                                         style="cursor: pointer;"
                                         @onclick="() => TogglePlayerExpansion(playerId)">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                                    Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                @(player?.FullName ?? $"Player {playerId}")
                                            </MudText>
                                        </div>
                                        <div class="d-flex align-center gap-3">
                                            <div class="text-center">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Score</MudText>
                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">@totalStrokes</MudText>
                                            </div>
                                            <div class="text-center">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">To Par</MudText>
                                                <MudChip T="string" 
                                                        Size="Size.Small" 
                                                        Color="@GetScoreColor(scoreToPar)">
                                                    @FormatHoleScore(scoreToPar)
                                                </MudChip>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Detailed Scorecard (collapsible) -->
                                    <MudCollapse Expanded="isExpanded">
                                        <div class="mt-3 pt-3" style="border-top: 1px solid #e0e0e0;">
                                            <div class="mobile-scorecard">
                                                @foreach (var score in playerScores)
                                                {
                                                    var holeNumber = score.Hole?.HoleNumber ?? 1;
                                                    var holePar = score.Hole?.Par ?? 4;
                                                    var holeScoreToPar = score.Strokes - holePar;
                                                    
                                                    <div class="d-flex justify-space-between align-center py-2 @(holeNumber % 2 == 0 ? "bg-grey-50" : "")">
                                                        <div class="d-flex align-center">
                                                            <MudText Typo="Typo.body2" Style="font-weight: 600; min-width: 30px;">
                                                                @holeNumber
                                                            </MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-2">
                                                                Par @holePar
                                                            </MudText>
                                                        </div>
                                                        
                                                        <div class="d-flex align-center">
                                                            <MudText Typo="Typo.body1" Style="font-weight: 600; margin-right: 8px;">
                                                                @score.Strokes
                                                            </MudText>
                                                            <MudChip T="string" 
                                                                    Size="Size.Small" 
                                                                    Color="@GetScoreColor(holeScoreToPar)"
                                                                    Style="min-width: 40px;">
                                                                @FormatHoleScore(holeScoreToPar)
                                                            </MudChip>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </MudCollapse>
                                </MudCardContent>
                            </MudCard>
                        }
                    </MudCardContent>
                </MudCard>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Secondary" OnClick="CloseDetailsDialog">Close</MudButton>
        <MudButton Color="Color.Info" 
                  Variant="Variant.Outlined" 
                  StartIcon="@Icons.Material.Filled.Edit"
                  OnClick="@(() => EditRoundFromMenu(selectedRound!))">
            Edit
        </MudButton>
    </DialogActions>
</MudDialog>
@code {
    private List<LocalRound>? rounds;
    private List<LocalRound>? filteredRounds;
    private List<Score>? scores;
    private List<GolfTrackerApp.Mobile.Services.Api.ScoreResponse>? apiScores;
    private Dictionary<int, bool> expandedPlayers = new();
    private bool loading = true;
    private bool showDetailsDialog = false;
    private LocalRound? selectedRound;
    private string searchString = "";
    private int totalRounds = 0;
    
    private DialogOptions detailsDialogOptions = new() 
    { 
        MaxWidth = MaxWidth.Medium, 
        FullWidth = true,
        CloseButton = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadRounds();
    }

    private async Task LoadRounds()
    {
        try
        {
            loading = true;
            
            // Get rounds from API service
            var roundResponses = await RoundApiService.GetRoundsAsync(1, 50); // Load more for search
            
            // Convert API responses to Round model for UI
            rounds = roundResponses.Select(r => new LocalRound
            {
                Id = r.RoundId,
                CourseName = r.CourseName,
                ClubName = r.ClubName,
                DatePlayed = r.DatePlayed,
                TotalScore = r.TotalScore,
                Par = r.TotalPar,
                Holes = r.HolesPlayed,
                Notes = r.Notes ?? string.Empty,
                PlayingPartners = r.PlayingPartners ?? new List<string>(),
                Weather = "N/A", // Would need to add weather field to API
                PlayerCount = r.PlayerCount,
                RoundType = r.RoundType
            }).OrderByDescending(r => r.DatePlayed).ToList();
            
            totalRounds = rounds?.Count ?? 0;
            ApplySearchFilter();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading rounds: {ex.Message}");
            rounds = new List<LocalRound>();
            filteredRounds = new List<LocalRound>();
            totalRounds = 0;
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchTextChanged(string text)
    {
        searchString = text;
        ApplySearchFilter();
        await Task.CompletedTask;
    }

    private void ApplySearchFilter()
    {
        if (rounds == null)
        {
            filteredRounds = new List<LocalRound>();
            return;
        }

        if (string.IsNullOrWhiteSpace(searchString))
        {
            filteredRounds = rounds;
        }
        else
        {
            var searchTerm = searchString.Trim().ToLowerInvariant();
            filteredRounds = rounds.Where(r =>
                r.CourseName.ToLowerInvariant().Contains(searchTerm) ||
                r.ClubName.ToLowerInvariant().Contains(searchTerm)
            ).ToList();
        }
        
        StateHasChanged();
    }

    private async Task ShowRoundDetails(LocalRound round)
    {
        selectedRound = round;
        await LoadRoundScores(round.Id);
        showDetailsDialog = true;
    }

    private async Task EditRoundFromMenu(LocalRound round)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"Edit functionality coming soon for round at {round.CourseName}!");
    }

    private async Task DeleteRoundFromMenu(LocalRound round)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"Delete functionality coming soon for round at {round.CourseName}!");
    }

    private async Task LoadRoundScores(int roundId)
    {
        try
        {
            // Get real scores from API
            apiScores = await RoundApiService.GetRoundScoresAsync(roundId);
            
            // Initialize expanded players state (all collapsed by default)
            expandedPlayers.Clear();
            var playerIds = apiScores.Select(s => s.PlayerId).Distinct();
            foreach (var playerId in playerIds)
            {
                expandedPlayers[playerId] = false;
            }
            
            // Keep the old scores format for backward compatibility, but use real par values
            scores = apiScores.Select(s => new Score
            {
                Id = s.ScoreId,
                RoundId = s.RoundId,
                HoleNumber = s.Hole?.HoleNumber ?? 1,
                Strokes = s.Strokes,
                Par = s.Hole?.Par ?? 4,
                Putts = s.Putts,
                FairwayHit = s.FairwayHit ?? false,
                GreenInRegulation = false
            }).ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading scores: {ex.Message}");
            apiScores = new List<GolfTrackerApp.Mobile.Services.Api.ScoreResponse>();
            scores = new List<Score>();
        }
    }

    private void CloseDetailsDialog()
    {
        showDetailsDialog = false;
        selectedRound = null;
        scores = null;
        apiScores = null;
        expandedPlayers.Clear();
    }

    private void TogglePlayerExpansion(int playerId)
    {
        expandedPlayers[playerId] = !expandedPlayers.GetValueOrDefault(playerId, false);
    }

    private string GetRoundTypeDisplay(LocalRound round)
    {
        return string.IsNullOrEmpty(round.RoundType) ? "Friendly" : round.RoundType;
    }

    private string GetPlayerCountDisplay(LocalRound round)
    {
        return round.PlayerCount > 0 ? round.PlayerCount.ToString() : "1";
    }

    private string FormatScoreToPar(int score, int par)
    {
        var diff = score - par;
        if (diff == 0) return "E";
        return diff > 0 ? $"+{diff}" : diff.ToString();
    }

    private string FormatHoleScore(int diff)
    {
        if (diff == 0) return "E";
        return diff > 0 ? $"+{diff}" : diff.ToString();
    }

    private Color GetScoreColor(int scoreToPar)
    {
        return scoreToPar switch
        {
            <= -2 => Color.Success,
            -1 => Color.Info,
            0 => Color.Primary,
            1 => Color.Warning,
            _ => Color.Error
        };
    }
}
